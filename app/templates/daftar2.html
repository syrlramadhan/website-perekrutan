{% extends 'base.html' %}

{% block content %}
<main id="main">
    <section id="daftar-hero" class="d-flex align-items-center position-relative overflow-hidden py-5">
        <div class="background-animation"></div>
        <div class="container position-relative z-index-1" data-aos="fade-up">
            <div class="row justify-content-center text-center">
                <div class="col-lg-8">
                    <h1 class="display-4 fw-bold --secondary-blue mb-3">Daftar Anggota Baru</h1>
                    <p class="lead --secondary-blue">Isi formulir di bawah ini untuk memulai perjalananmu bersama COCONUT Computer Club.</p>
                </div>
            </div>
        </div>
    </section><section id="daftar-form" class="py-5">
        <div class="container" data-aos="fade-up" data-aos-delay="100">
            <div class="row justify-content-center">
                <div class="col-lg-10">
                    <div class="card p-4 p-md-5 shadow-lg border-0 rounded-4">
                        <div class="text-center mb-5">
                            <h2 class="fw-bolder text-primary">Formulir Pendaftaran Anggota</h2>
                            <p class="lead fw-normal text-muted mb-0">Isi setiap kolom dengan data yang valid dan akurat.</p>
                        </div>
                        <form id="daftarForm" class="row g-4">
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="nama_lengkap" name="nama_lengkap" type="text" placeholder="Masukkan Nama Lengkap..." data-sb-validations="required" />
                                    <label for="nama_lengkap">Nama Lengkap</label>
                                    <div class="invalid-feedback" data-sb-feedback="nama_lengkap:required">Nama Lengkap diperlukan.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="nama_panggilan" name="nama_panggilan" type="text" placeholder="Masukkan Nama Panggilan..." data-sb-validations="required" />
                                    <label for="nama_panggilan">Nama Panggilan</label>
                                    <div class="invalid-feedback" data-sb-feedback="nama_panggilan:required">Nama Panggilan diperlukan.</div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label class="form-label fw-semibold">Jenis Kelamin</label>
                                <div class="d-flex gap-4 mt-2">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="jenis_kelamin" id="pria" value="Pria" data-sb-validations="required" />
                                        <label class="form-check-label" for="pria">Pria</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" name="jenis_kelamin" id="wanita" value="Wanita" data-sb-validations="required" />
                                        <label class="form-check-label" for="wanita">Wanita</label>
                                    </div>
                                </div>
                                <div class="invalid-feedback" data-sb-feedback="jenis_kelamin:required">Pilih jenis kelamin.</div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="email" name="email" type="email" placeholder="name@example.com" data-sb-validations="required,email" />
                                    <label for="email">Alamat Email</label>
                                    <div class="invalid-feedback" data-sb-feedback="email:required">Email diperlukan.</div>
                                    <div class="invalid-feedback" data-sb-feedback="email:email">Email tidak valid.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="nomor_wa" name="nomor_wa" type="tel" placeholder="+62 812 4567 8910" data-sb-validations="required" pattern="[0-9]+" />
                                    <label for="nomor_wa">Nomor WhatsApp</label>
                                    <div class="invalid-feedback" data-sb-feedback="nomor_wa:required">Nomor WhatsApp diperlukan.</div>
                                    <div class="invalid-feedback" data-sb-feedback="nomor_wa:pattern">Hanya angka yang diperbolehkan.</div>
                                </div>
                            </div>

                            <div class="col-12">
                                <div class="form-floating">
                                    <input class="form-control" id="username_telegram" name="username_telegram" type="text" placeholder="Masukkan Username Telegram..." data-sb-validations="required" />
                                    <label for="username_telegram">Username Telegram</label>
                                    <div class="invalid-feedback" data-sb-feedback="username_telegram:required">Username Telegram diperlukan.</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="alamat" name="alamat" type="text" placeholder="Masukkan Alamat tempat tinggal..." data-sb-validations="required" />
                                    <label for="alamat">Alamat Tempat Tinggal</label>
                                    <div class="invalid-feedback" data-sb-feedback="alamat:required">Alamat tempat tinggal diperlukan.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <select class="form-select" id="pilihan_tinggal" name="pilihan_tinggal" data-sb-validations="required">
                                        <option value="" disabled selected>Pilih...</option>
                                        <option value="Orangtua">Tinggal dengan Orangtua</option>
                                        <option value="Keluarga">Tinggal dengan Keluarga</option>
                                        <option value="Kost">Kost</option>
                                    </select>
                                    <label for="pilihan_tinggal">Pilihan Tinggal</label>
                                    <div class="invalid-feedback" data-sb-feedback="pilihan_tinggal:required">Pilihan tempat tinggal diperlukan.</div>
                                </div>
                            </div>

                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="kampus" name="kampus" type="text" placeholder="Masukkan Asal Kampus..." data-sb-validations="required" />
                                    <label for="kampus">Asal Kampus</label>
                                    <div class="invalid-feedback" data-sb-feedback="kampus:required">Asal Kampus diperlukan.</div>
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="form-floating">
                                    <input class="form-control" id="jurusan" name="jurusan" type="text" placeholder="Masukkan Jurusan..." data-sb-validations="required" />
                                    <label for="jurusan">Jurusan</label>
                                    <div class="invalid-feedback" data-sb-feedback="jurusan:required">Jurusan diperlukan.</div>
                                </div>
                            </div>

                            <div class="col-12">
                                <label for="photo" class="form-label fw-semibold">Unggah Foto Anda <span class="text-muted">(file .jpg, .jpeg, .png)</span></label>
                                <input type="file" class="form-control" id="photo" name="photo" accept=".jpg, .jpeg, .png" data-sb-validations="required" />
                                <div class="invalid-feedback" data-sb-feedback="photo:required">Foto Anda diperlukan.</div>
                                <div class="invalid-feedback" data-sb-feedback="photo:accept">Hanya file .jpg, .jpeg, atau .png yang diperbolehkan.</div>
                            </div>
                            
                            <div class="col-12">
                                <div class="form-floating">
                                    <textarea class="form-control" id="alasan" name="alasan" type="text" placeholder="Masukkan alasan anda di sini..." style="height: 10rem" data-sb-validations="required"></textarea>
                                    <label for="alasan">Alasan Masuk COCONUT</label>
                                    <div class="invalid-feedback" data-sb-feedback="alasan:required">Alasan Masuk diperlukan.</div>
                                </div>
                            </div>

                            <div class="d-none" id="submitSuccessMessage">
                                <div class="text-center mb-3 text-success">
                                    <div class="fw-bolder">Formulir pendaftaran berhasil dikirim!</div>
                                    <p>Kami telah menerima datamu. Silakan cek emailmu untuk petunjuk selanjutnya.</p>
                                    <a href="{{ url_for('index')}}">Kembali ke halaman utama</a>
                                </div>
                            </div>
                            <div class="d-none" id="submitErrorMessage">
                                <div class="text-center text-danger mb-3">Terjadi kesalahan saat mengirim formulir. Mohon coba lagi!</div>
                            </div>
                            <div class="col-12 text-center">
                                <button class="btn btn-primary btn-lg rounded-pill px-5 shadow-sm" id="submitButton" type="submit">DAFTAR</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </section>

</main>
{% endblock %}

{% block scripts %}
<script>
    // Fungsionalitas formulir dan pengiriman data
    document.addEventListener("DOMContentLoaded", function () {
        const daftarForm = document.getElementById('daftarForm');
        const submitButton = document.getElementById('submitButton');
        const successMessage = document.getElementById('submitSuccessMessage');
        const errorMessage = document.getElementById('submitErrorMessage');

        function sendData(formData) {
            // Debug: Log form data
            console.log('Sending form data:');
            for (let [key, value] of formData.entries()) {
                console.log(key, value);
            }
            
            fetch('/api/postData', {
                method: 'POST',
                body: formData,
            })
            .then(response => {
                console.log('Response status:', response.status);
                if (!response.ok) {
                    throw new Error(`HTTP error! status: ${response.status}`);
                }
                return response.json();
            })
                .then(data => {
                    console.log('Response:', data);
                    if (data.status === 'success') {
                        daftarForm.reset();
                        successMessage.classList.remove('d-none');
                        errorMessage.classList.add('d-none');
                        showToast('success', 'Pendaftaran berhasil! Terima kasih telah mendaftar.');
                    } else {
                        throw new Error(data.message || 'Server responded with an error');
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    errorMessage.classList.remove('d-none');
                    successMessage.classList.add('d-none');
                    showToast('danger', 'Terjadi kesalahan: ' + error.message);
                })
            .finally(() => {
                submitButton.disabled = false;
            });
        }

        daftarForm.addEventListener('submit', function (event) {
            event.preventDefault();
            console.log('Form submission started');
            submitButton.disabled = true;

            const formData = new FormData(this);
            
            // Handle photo file
            const photoInput = document.getElementById('photo');
            if (photoInput.files.length > 0) {
                formData.set('photo', photoInput.files[0]);
                console.log('Photo file added:', photoInput.files[0].name);
            } else {
                console.log('No photo file selected');
            }

            // Debug: Log all form fields
            console.log('Form fields before sending:');
            for (let [key, value] of formData.entries()) {
                console.log(`${key}: ${value}`);
            }
            
            sendData(formData);
        });
    });
</script>
<!-- Toast container -->
<div id="toast-container" class="position-fixed top-0 end-0 p-3" style="z-index: 1080;"></div>

<script>
// helper to show Bootstrap toast messages
function showToast(type, message, title) {
        title = title || (type === 'success' ? 'Sukses' : 'Error');
        try {
                const container = document.getElementById('toast-container');
                if (!container) return;
                const toastId = 'toast-' + Date.now();
                const bgClass = type === 'success' ? 'bg-success text-white' : 'bg-danger text-white';
                const html = `
                <div id="${toastId}" class="toast ${bgClass}" role="alert" aria-live="assertive" aria-atomic="true">
                    <div class="d-flex">
                        <div class="toast-body">${message}</div>
                        <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                    </div>
                </div>`;
                const temp = document.createElement('div');
                temp.innerHTML = html;
                const toastEl = temp.firstElementChild;
                container.appendChild(toastEl);
                // eslint-disable-next-line no-undef
                const bsToast = bootstrap && bootstrap.Toast ? new bootstrap.Toast(toastEl, { delay: 5000 }) : null;
                if (bsToast) bsToast.show();
                // remove toast from DOM after hidden
                toastEl.addEventListener('hidden.bs.toast', function () { toastEl.remove(); });
                // fallback removal after 6s if bootstrap not present
                setTimeout(() => { if (document.getElementById(toastId)) toastEl.remove(); }, 7000);
        } catch (e) {
                console.warn('showToast error', e);
                alert(message);
        }
}
</script>
<script src="https://cdn.startbootstrap.com/sb-forms-latest.js"></script>
{% endblock %}